import pygame, sys

from scripts.tilemap import TileMap
from scripts.camera import Camera

WIDTH, HEIGHT = 800, 600 #fenster größe
FPS = 60 #bilder pro sekunde


class Game:
   def __init__(self):
      pygame.init()

      #fenster titel
      pygame.display.set_caption("jump game")

      #fenster größe
      self.screen = pygame.display.set_mode((WIDTH, HEIGHT))
      self.display = pygame.Surface((WIDTH/1, HEIGHT/1))

      #fps steuerung
      self.clock = pygame.time.Clock()

      #orte vom bildschirm
      self.centerofscreen_x = (self.display.get_width()) // 2
      def centerofscreen_x(input):
         return self.centerofscreen_x - input // 2
      self.centerofscreen_y = (self.display.get_height()) // 2
      def centerofscreen_y(input):
         return self.centerofscreen_y - input // 2

      #gui
      self.font = pygame.font.SysFont(None, 32)

      #spieler
      self.playerSize = [25, 45]
      self.playerPos = [centerofscreen_x(self.playerSize[0]), 50]
      # Load player image
      try:
         self.player_image = pygame.image.load("blobbob.png").convert_alpha()
         self.playerSize = [100, 100]
         self.player_image = pygame.transform.scale(self.player_image, (self.playerSize[0], self.playerSize[1]))
      except Exception as e:
         print("Could not load player image blobbob.png:", e)
         self.player_image = None
      self.player = pygame.Rect(self.playerPos[0], self.playerPos[1], self.playerSize[0], self.playerSize[1])
      self.JUMP_STRENGTH = -8
      self.velocity_y = 0
      self.flip = False

      #demo level
      demo_level = [
         [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0],
         [0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 1, 0],
         [0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 0],
         [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
      ]
      demo_level1 = [
         [0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0],
         [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
      ]

      #Tilemap
      self.level = TileMap(32, demo_level1, self.display)

      # Camera
      self.camera = Camera(self.display.get_width(), self.display.get_height())

      #physik variablen
      self.GRAVITY = 0.25

      #farben variablen
      self.BG = (200, 180, 150) #hintergrund farbe
      self.WEISS = (255, 255, 255) #spieler farbe
      self.SCHWARZ = (0, 0, 0) #ground farbe
      self.ROT = (255, 0, 0) #ROT
   
   def update(self):
      #reset bewegung
      self.velocity_x = 0

      #apply gravity
      self.velocity_y += self.GRAVITY

      #move player vertically
      self.player.y += self.velocity_y

      #feet collider
      self.player_feet = pygame.Rect( #x, y, breite, höhe
         self.player.x,
         self.player.bottom,
         self.player.width,
         5
      )

      #tile collision
      self.on_ground = False
      for tile_rect in self.level.get_collision_rects():
         if self.player_feet.colliderect(tile_rect) and self.velocity_y >= 0:
            self.player.bottom = tile_rect.top
            self.velocity_y = 0
            self.on_ground = True
            break

      key = pygame.key.get_pressed()
      if key[pygame.K_d] or key[pygame.K_RIGHT]:
         self.velocity_x = 5
      elif key[pygame.K_a] or key[pygame.K_LEFT]:
         self.velocity_x = -5   

      #move player horizontal
      self.player.x += self.velocity_x

      # Update camera to follow player
      self.camera.follow(self.player)

      #jump
      if key[pygame.K_SPACE] and self.on_ground:
         self.velocity_y += self.JUMP_STRENGTH

   def draw(self):
      #hintergrund farbe
      self.display.fill(self.BG)

      #tilemap with camera offset
      self.level.draw(self.display, self.camera.offset) #tilemap

      #draw player with camera offset
      player_draw_rect = self.player.copy()
      player_draw_rect.x -= self.camera.offset.x
      player_draw_rect.y -= self.camera.offset.y
      if self.player_image:
         self.display.blit(self.player_image, player_draw_rect)
      else:
         pygame.draw.rect(self.display, self.WEISS, player_draw_rect) #player fallback

      #draw player feet with camera offset
      player_feet_draw_rect = self.player_feet.copy()
      player_feet_draw_rect.x -= self.camera.offset.x
      player_feet_draw_rect.y -= self.camera.offset.y
      pygame.draw.rect(self.display, self.ROT, player_feet_draw_rect) #player füße

      #gui
      fps_text = self.font.render(f'FPS: {int(self.clock.get_fps())}', True, (0, 0, 0))
      self.display.blit(fps_text, (10, 10))

      pos_text = self.font.render(f'Pos: {self.player.x}, {self.player.y}', True, (0, 0, 0))
      self.display.blit(pos_text, (10, 40))

      pygame.display.flip() #bildschirm aktualisieren

   def respawnPlayer(self):
      self.player.x = self.playerPos[0]
      self.player.y = self.playerPos[1]
      self.velocity_y = 0

   #game schleife
   def run(self):
      while True:
         for event in pygame.event.get():
            if event.type == pygame.QUIT or event.type == pygame.KEYDOWN and event.key == pygame.K_ESCAPE:
               pygame.quit()
               sys.exit()
            if event.type == pygame.KEYDOWN and event.key == pygame.K_r or self.playerPos[1] > 500:
                  self.respawnPlayer()
               

         self.update()
         self.draw()
      
         self.screen.blit(pygame.transform.scale(self.display, self.screen.get_size()), (0, 0)) #skalierung
         self.clock.tick(FPS) #FPS

if __name__ == '__main__':
   game = Game()
   game.run()